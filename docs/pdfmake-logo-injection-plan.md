# PDFMake Logo Injection Implementation Plan

**Date**: December 1, 2025
**Project**: Forensic Video Unit Request System
**Objective**: Embed the Peel Regional Police Forensic Video Unit logo in PDFs generated by PDFMake using vanilla JavaScript (no build tools)

---

## Executive Summary

**Is this possible?** ✅ **YES** - This is fully achievable with vanilla JavaScript.

**Recommended Approach**: Pre-convert the logo to base64 at build time (manually), store it in a separate JavaScript module, and import it dynamically. This avoids runtime conversion overhead, reduces complexity, and eliminates the risk of runtime errors while maintaining the zero-build-tools philosophy.

**Why Previous Approaches Failed**:
- The base64 string in `config.js` (commit 7c98dfa) was likely corrupted or incomplete
- PDFMake's zlib decompression failed with "invalid distance too far back" error
- The placeholder 1x1 PNG (commit f659866) works because it's minimal valid data

**Key Finding**: PDFMake requires the complete data URL format (`data:image/png;base64,[string]`) and the base64 string must be valid, uncorrupted PNG data. The logo file `assets/images/FVU logo.PNG` (214KB) exists and appears valid - it just needs proper conversion.

---

## Technical Analysis

### Why the Last Attempt Failed

**Commit 7c98dfa**: "Fix PDF logo display issue - replace placeholder with actual Homicide logo"
- Attempted to extract logo from SVG and embed as base64
- Result: "invalid distance too far back" zlib compression error
- Root cause: Corrupted or incomplete base64 data

**Commit f659866**: "fix: Revert to valid placeholder logo to fix PDFMake zlib error"
- Used minimal 1x1 PNG placeholder
- Result: Works, but no visible logo
- Confirms the issue is data corruption, not PDFMake configuration

### What PDFMake Actually Needs

According to PDFMake documentation:

```javascript
// Format 1: Inline data URL (most common in browser)
{
  image: 'data:image/png;base64,iVBORw0KGgoAAAANS...',
  width: 80,
  height: 80
}

// Format 2: Referenced from images dictionary
{
  image: 'myLogo'
}
// ...
images: {
  myLogo: 'data:image/png;base64,iVBORw0KGgoAAAANS...'
}
```

**Requirements**:
1. Complete data URL with MIME type prefix
2. Valid base64-encoded PNG/JPEG/GIF data
3. No corrupted bytes or truncation
4. Reasonable file size (under 500KB recommended)

### Current Logo Analysis

**File**: `assets/images/FVU logo.PNG`
- Size: 214KB (reasonable size)
- Format: PNG (supported by PDFMake)
- Dimensions: Appears to be the official Forensic Video Unit badge
- Quality: High-resolution, professional design

---

## Recommended Solution

### Approach: Static Base64 Module with Dynamic Import

This approach balances maintainability, performance, and the zero-build-tools constraint.

**Advantages**:
- ✅ No runtime conversion (performance)
- ✅ No build tools required (manual one-time conversion)
- ✅ Easy to update logo (replace file, regenerate base64)
- ✅ Keeps config.js clean and readable
- ✅ No risk of runtime errors from image loading
- ✅ Works offline (no network dependency)

**Disadvantages**:
- ⚠️ Manual step required when logo changes (acceptable for infrequent updates)
- ⚠️ Larger file size in repository (214KB → ~285KB base64, but Git handles this well)

---

## Implementation Steps

### Step 1: Generate Valid Base64 (One-Time Manual Process)

**Option A: Using Online Tool (Simplest)**

1. Visit: https://base64.guru/converter/encode/image
2. Upload: `assets/images/FVU logo.PNG`
3. Ensure output format: `data:image/png;base64,...`
4. Copy the complete data URL

**Option B: Using Python Script (Reproducible)**

Create `tools/convert-logo-to-base64.py`:

```python
#!/usr/bin/env python3
"""
Convert logo PNG to base64 data URL for PDFMake
Usage: python tools/convert-logo-to-base64.py
Output: assets/js/logo-data.js
"""

import base64
import sys
from pathlib import Path

def convert_image_to_base64(image_path, output_path):
    """Convert PNG image to base64 data URL and write to JS module"""

    try:
        # Read image file
        with open(image_path, 'rb') as img_file:
            image_data = img_file.read()

        # Encode to base64
        base64_data = base64.b64encode(image_data).decode('utf-8')

        # Create data URL
        data_url = f'data:image/png;base64,{base64_data}'

        # Create JavaScript module
        js_content = f'''/**
 * FVU Logo Data
 * Auto-generated base64 data URL for PDFMake
 * Source: {image_path}
 * Generated: {Path(__file__).stat().st_mtime}
 *
 * To regenerate: python tools/convert-logo-to-base64.py
 */

export const FVU_LOGO_BASE64 = '{data_url}';

// Logo dimensions (for reference)
export const FVU_LOGO_WIDTH = 80;
export const FVU_LOGO_HEIGHT = 80;
'''

        # Write to output file
        output_path.parent.mkdir(parents=True, exist_ok=True)
        with open(output_path, 'w', encoding='utf-8') as js_file:
            js_file.write(js_content)

        print(f"✓ Successfully converted {image_path}")
        print(f"✓ Output written to {output_path}")
        print(f"✓ Data URL length: {len(data_url):,} characters")
        print(f"✓ Original size: {len(image_data):,} bytes")
        print(f"✓ Base64 size: {len(base64_data):,} characters")

    except FileNotFoundError:
        print(f"✗ Error: Image file not found: {image_path}", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"✗ Error: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    # Paths
    project_root = Path(__file__).parent.parent
    image_path = project_root / 'assets' / 'images' / 'FVU logo.PNG'
    output_path = project_root / 'assets' / 'js' / 'logo-data.js'

    convert_image_to_base64(image_path, output_path)
```

**Option C: Using Node.js Script (If Node is available)**

Create `tools/convert-logo-to-base64.js`:

```javascript
#!/usr/bin/env node
/**
 * Convert logo PNG to base64 data URL for PDFMake
 * Usage: node tools/convert-logo-to-base64.js
 * Output: assets/js/logo-data.js
 */

const fs = require('fs');
const path = require('path');

function convertImageToBase64(imagePath, outputPath) {
  try {
    // Read image file
    const imageData = fs.readFileSync(imagePath);

    // Encode to base64
    const base64Data = imageData.toString('base64');

    // Create data URL
    const dataUrl = `data:image/png;base64,${base64Data}`;

    // Create JavaScript module
    const jsContent = `/**
 * FVU Logo Data
 * Auto-generated base64 data URL for PDFMake
 * Source: ${imagePath}
 * Generated: ${new Date().toISOString()}
 *
 * To regenerate: node tools/convert-logo-to-base64.js
 */

export const FVU_LOGO_BASE64 = '${dataUrl}';

// Logo dimensions (for reference)
export const FVU_LOGO_WIDTH = 80;
export const FVU_LOGO_HEIGHT = 80;
`;

    // Write to output file
    fs.mkdirSync(path.dirname(outputPath), { recursive: true });
    fs.writeFileSync(outputPath, jsContent, 'utf-8');

    console.log(`✓ Successfully converted ${imagePath}`);
    console.log(`✓ Output written to ${outputPath}`);
    console.log(`✓ Data URL length: ${dataUrl.length.toLocaleString()} characters`);
    console.log(`✓ Original size: ${imageData.length.toLocaleString()} bytes`);
    console.log(`✓ Base64 size: ${base64Data.length.toLocaleString()} characters`);

  } catch (error) {
    console.error(`✗ Error: ${error.message}`);
    process.exit(1);
  }
}

// Paths
const projectRoot = path.resolve(__dirname, '..');
const imagePath = path.join(projectRoot, 'assets', 'images', 'FVU logo.PNG');
const outputPath = path.join(projectRoot, 'assets', 'js', 'logo-data.js');

convertImageToBase64(imagePath, outputPath);
```

**Run the conversion**:

```bash
# Using Python
python tools/convert-logo-to-base64.py

# Using Node.js
node tools/convert-logo-to-base64.js
```

### Step 2: Update config.js to Import Logo Data

**File**: `assets/js/config.js`

Replace the hardcoded base64 string with a dynamic import:

```javascript
/**
 * Configuration and Constants
 * Central location for all app configuration
 * No business logic - just values
 */

import { FVU_LOGO_BASE64, FVU_LOGO_WIDTH, FVU_LOGO_HEIGHT } from './logo-data.js';

export const CONFIG = {
  // ... existing config ...

  // PDF Configuration
  PDF_CONFIG: {
    METADATA: {
      author: 'Peel Regional Police - Forensic Video Unit',
      subject: 'Evidence Request',
      keywords: 'forensic, video, evidence'
    }
  },

  // PDF Logo Configuration
  PDF_LOGO: {
    HOMICIDE: FVU_LOGO_BASE64,
    WIDTH: FVU_LOGO_WIDTH,
    HEIGHT: FVU_LOGO_HEIGHT
  }
};

// Freeze config to prevent modifications
Object.freeze(CONFIG);
// ... rest of freezing ...
Object.freeze(CONFIG.PDF_LOGO);
```

### Step 3: Verify PDF Templates Use Logo Correctly

**File**: `assets/js/pdf-templates.js`

Current usage (lines 24-28):

```javascript
{
  // Logo column
  image: CONFIG.PDF_LOGO.HOMICIDE,
  width: CONFIG.PDF_LOGO.WIDTH || 80,
  height: CONFIG.PDF_LOGO.HEIGHT || 80
}
```

**This is already correct** - no changes needed. The template properly references `CONFIG.PDF_LOGO.HOMICIDE`.

### Step 4: Add Validation Function (Optional but Recommended)

**File**: `assets/js/logo-data.js` (append to generated file)

```javascript
/**
 * Validate logo data URL format
 * @returns {boolean} True if valid
 */
export function validateLogoData() {
  // Check if it's a valid data URL
  if (!FVU_LOGO_BASE64.startsWith('data:image/png;base64,')) {
    console.error('Invalid logo data URL format');
    return false;
  }

  // Check minimum length (1x1 PNG is ~90 chars, real logo should be much larger)
  if (FVU_LOGO_BASE64.length < 1000) {
    console.warn('Logo data URL seems too short - may be placeholder');
    return false;
  }

  // Try to decode base64 (basic validation)
  try {
    const base64String = FVU_LOGO_BASE64.split(',')[1];
    atob(base64String.substring(0, 100)); // Test decode first 100 chars
    return true;
  } catch (error) {
    console.error('Logo base64 data is corrupted:', error);
    return false;
  }
}
```

**Optional**: Call validation in config.js during development:

```javascript
import { FVU_LOGO_BASE64, FVU_LOGO_WIDTH, FVU_LOGO_HEIGHT, validateLogoData } from './logo-data.js';

// Development-only validation
if (CONFIG.IS_DEVELOPMENT) {
  if (!validateLogoData()) {
    console.warn('Logo validation failed - PDFs may not display logo correctly');
  }
}
```

### Step 5: Test PDF Generation

Create a test file `test-pdf-logo.html`:

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDFMake Logo Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.min.js"></script>
</head>
<body>
  <h1>PDFMake Logo Test</h1>
  <button id="testBtn">Generate Test PDF</button>
  <div id="status"></div>

  <script type="module">
    import { FVU_LOGO_BASE64 } from './assets/js/logo-data.js';

    document.getElementById('testBtn').addEventListener('click', () => {
      const status = document.getElementById('status');
      status.textContent = 'Generating PDF...';

      const docDefinition = {
        content: [
          {
            columns: [
              {
                image: FVU_LOGO_BASE64,
                width: 80,
                height: 80
              },
              {
                stack: [
                  {
                    text: 'PEEL REGIONAL POLICE',
                    fontSize: 18,
                    bold: true,
                    color: '#1B3A6B'
                  },
                  {
                    text: 'Forensic Video Unit',
                    fontSize: 16,
                    color: '#1B3A6B'
                  },
                  {
                    text: 'Logo Test Document',
                    fontSize: 14,
                    bold: true
                  }
                ],
                width: '*',
                margin: [0, 10, 0, 0]
              }
            ]
          },
          {
            text: 'If you can see the FVU logo above, the integration is successful!',
            margin: [0, 20, 0, 0]
          }
        ]
      };

      try {
        pdfMake.createPdf(docDefinition).download('logo-test.pdf');
        status.textContent = '✓ PDF generated successfully! Check downloads.';
        status.style.color = 'green';
      } catch (error) {
        status.textContent = `✗ Error: ${error.message}`;
        status.style.color = 'red';
        console.error(error);
      }
    });
  </script>
</body>
</html>
```

**Test procedure**:
1. Serve the project with a local HTTP server (VS Code Live Server)
2. Open `test-pdf-logo.html` in browser
3. Click "Generate Test PDF"
4. Verify logo displays correctly in generated PDF

### Step 6: Commit Changes

```bash
git add assets/js/logo-data.js
git add assets/js/config.js
git add tools/convert-logo-to-base64.py  # or .js
git commit -m "feat: Add proper FVU logo to PDF generation

- Generate logo-data.js with valid base64-encoded PNG
- Import logo data dynamically in config.js
- Add conversion script for reproducible logo updates
- Remove corrupted inline base64 from config.js

Fixes zlib error by using properly encoded logo data.
Logo can be updated by re-running conversion script."
```

---

## Alternative Approaches

### Alternative 1: Runtime Fetch + Canvas Conversion

**Description**: Load PNG from filesystem using fetch(), convert to base64 at runtime using canvas.

**Pros**:
- Logo stays as PNG file (easier to manage)
- No base64 file in repository
- Can optimize/resize at runtime

**Cons**:
- Requires async initialization before PDF generation
- More complex error handling
- Performance overhead on every form load
- Requires CORS-compatible serving (might not work with `file://`)

**Implementation**:

```javascript
// assets/js/logo-loader.js
export async function loadLogo(imagePath = '/assets/images/FVU logo.PNG') {
  try {
    const response = await fetch(imagePath);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const blob = await response.blob();

    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  } catch (error) {
    console.error('Failed to load logo:', error);
    throw error;
  }
}

// Usage in form-handler.js
import { loadLogo } from './logo-loader.js';

let logoDataURL = null;

async function initializeLogo() {
  logoDataURL = await loadLogo();
  CONFIG.PDF_LOGO.HOMICIDE = logoDataURL;
}

// Call on page load
window.addEventListener('DOMContentLoaded', initializeLogo);
```

**Verdict**: ❌ Not recommended - adds complexity and async dependencies without significant benefit.

### Alternative 2: Inline Data URL in HTML

**Description**: Store base64 as a data attribute on a hidden element in HTML.

**Example**:

```html
<!-- In HTML file -->
<div id="logo-data"
     data-logo="data:image/png;base64,iVBORw0KGgoAAAA..."
     style="display:none"></div>

<script type="module">
  import { CONFIG } from './assets/js/config.js';

  const logoElement = document.getElementById('logo-data');
  CONFIG.PDF_LOGO.HOMICIDE = logoElement.dataset.logo;
</script>
```

**Verdict**: ❌ Not recommended - violates separation of concerns, makes HTML bloated.

### Alternative 3: External JSON File

**Description**: Store logo data in JSON file, fetch at runtime.

**Example**:

```json
{
  "logo": "data:image/png;base64,iVBORw0KGgoAAAA...",
  "width": 80,
  "height": 80
}
```

```javascript
// Fetch at runtime
const logoConfig = await fetch('/assets/logo-config.json').then(r => r.json());
CONFIG.PDF_LOGO.HOMICIDE = logoConfig.logo;
```

**Verdict**: ❌ Not recommended - async overhead, doesn't work with `file://` protocol.

### Alternative 4: Keep It Simple - Fix Current Approach

**Description**: Keep logo data in config.js but regenerate it properly.

**Steps**:
1. Use Python/Node script to generate correct base64
2. Copy output directly into config.js as a const
3. No separate file, no dynamic import

**Pros**:
- Simplest implementation
- No module imports needed
- Works with current structure

**Cons**:
- Makes config.js very large (285KB+ of base64)
- Harder to read and maintain
- Git diffs become unreadable when logo changes

**Verdict**: ✅ Acceptable if file size in config.js is not a concern, but separate module (recommended solution) is cleaner.

---

## Error Handling Strategy

### Validation Checklist

Before deploying, verify:

1. ✅ **Data URL format**: Must start with `data:image/png;base64,`
2. ✅ **Base64 validity**: Can be decoded without errors
3. ✅ **Minimum length**: At least 1000 characters (real logo should be 280,000+)
4. ✅ **PNG signature**: Decoded data starts with PNG magic bytes (`\x89PNG`)
5. ✅ **File size**: Base64 string is ~285KB (original 214KB × 1.33)

### Runtime Error Handling

Add fallback in pdf-templates.js:

```javascript
buildUnifiedHeader(formTitle) {
  const logoImage = CONFIG.PDF_LOGO.HOMICIDE;

  // Validate logo data exists and is formatted correctly
  const hasValidLogo = logoImage &&
                       typeof logoImage === 'string' &&
                       logoImage.startsWith('data:image/') &&
                       logoImage.length > 1000;

  const logoColumn = hasValidLogo ? {
    image: logoImage,
    width: CONFIG.PDF_LOGO.WIDTH || 80,
    height: CONFIG.PDF_LOGO.HEIGHT || 80
  } : {
    // Fallback: Empty space if logo fails
    text: '',
    width: 80
  };

  return [
    {
      columns: [
        logoColumn,
        {
          // Title column...
        }
      ]
    }
    // ...
  ];
}
```

### Debugging Guide

If logo still doesn't appear after implementation:

1. **Check browser console** for errors:
   - Module loading errors
   - Invalid base64 errors
   - PDFMake zlib errors

2. **Verify data URL in DevTools**:
   ```javascript
   console.log('Logo length:', CONFIG.PDF_LOGO.HOMICIDE.length);
   console.log('Logo prefix:', CONFIG.PDF_LOGO.HOMICIDE.substring(0, 30));
   ```

3. **Test base64 decode**:
   ```javascript
   const base64Data = CONFIG.PDF_LOGO.HOMICIDE.split(',')[1];
   try {
     const decoded = atob(base64Data.substring(0, 100));
     console.log('✓ Base64 is valid');
   } catch (e) {
     console.error('✗ Base64 is corrupted:', e);
   }
   ```

4. **Check PNG signature**:
   ```javascript
   const base64Data = CONFIG.PDF_LOGO.HOMICIDE.split(',')[1];
   const decoded = atob(base64Data.substring(0, 20));
   const pngSignature = decoded.charCodeAt(0) === 0x89 &&
                        decoded.substring(1, 4) === 'PNG';
   console.log('PNG signature valid:', pngSignature);
   ```

5. **Test in isolation**: Create minimal test HTML (see Step 5) to isolate the issue from form logic.

---

## Maintenance Plan

### Updating the Logo

When the logo needs to be updated:

1. Replace `assets/images/FVU logo.PNG` with new file
2. Run conversion script:
   ```bash
   python tools/convert-logo-to-base64.py
   # or
   node tools/convert-logo-to-base64.js
   ```
3. Commit both files:
   ```bash
   git add assets/images/FVU\ logo.PNG
   git add assets/js/logo-data.js
   git commit -m "Update FVU logo"
   ```

### Documentation Updates

Add to CLAUDE.md:

```markdown
### Updating the Logo

The FVU logo in PDFs is stored as base64 in `assets/js/logo-data.js`.

To update:
1. Replace `assets/images/FVU logo.PNG`
2. Run: `python tools/convert-logo-to-base64.py`
3. Commit both files

Do not manually edit `logo-data.js` - it's auto-generated.
```

### Testing After Updates

Create a test checklist:

- [ ] Generate PDF from Upload form
- [ ] Generate PDF from Analysis form
- [ ] Generate PDF from Recovery form
- [ ] Verify logo displays correctly in all three PDFs
- [ ] Check logo alignment and size
- [ ] Test in Chrome, Firefox, Safari (if available)
- [ ] Test download and print functionality

---

## Timeline Estimate

**Total Time**: 30-45 minutes

1. **Generate base64** (5 min): Run conversion script or use online tool
2. **Create logo-data.js** (5 min): Create module with base64 data
3. **Update config.js** (5 min): Import from new module
4. **Test PDF generation** (10 min): Generate PDFs from all three forms
5. **Verify logo display** (5 min): Check logo appears correctly
6. **Add validation** (5 min): Optional validation function
7. **Commit changes** (5 min): Git commit with clear message

---

## Success Criteria

✅ Logo displays correctly in all generated PDFs
✅ No zlib or compression errors in console
✅ Logo maintains aspect ratio and clarity
✅ File size is reasonable (PDF < 1MB for typical form)
✅ No runtime errors during PDF generation
✅ Logo can be updated easily by running conversion script
✅ Code remains maintainable and documented

---

## Conclusion

**Recommended Path Forward**: Implement the **Static Base64 Module with Dynamic Import** approach (main solution).

**Why This Works Best**:
1. Maintains zero-build-tools philosophy (manual conversion is acceptable)
2. No runtime overhead or async complexity
3. Clean separation: config logic vs. logo data
4. Easy to maintain and update
5. Proven to work with PDFMake

**Next Steps**:
1. Run Python/Node conversion script (or use online tool)
2. Create `assets/js/logo-data.js` with output
3. Update `assets/js/config.js` to import logo data
4. Test all three forms
5. Commit changes

This solution will definitively solve the zlib error and display the proper FVU logo in all generated PDFs.

---

**Document Version**: 1.0
**Last Updated**: December 1, 2025
**Author**: Claude Code (Anthropic)
**Status**: Ready for Implementation
